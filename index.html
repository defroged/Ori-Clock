<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Oriのとけいマスター ⏰</title>
<style>
  :root{
    --bg:#f7f9fc;
    --panel:#ffffff;
    --ink:#1f2937;
    --ink-soft:#475569;
    --accent:#6366f1;
    --accent-2:#22c55e;
    --bad:#ef4444;
    --ring:rgba(99,102,241,.25);
  }
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", "Noto Sans JP", "Meiryo", sans-serif;
    line-height:1.5;
  }
  header{
    position:sticky; top:0; z-index:10;
    background:linear-gradient(180deg,#fff,rgba(255,255,255,.85));
    backdrop-filter:saturate(140%) blur(6px);
    border-bottom:1px solid #e5e7eb;
  }
  .wrap{max-width:1100px; margin:0 auto; padding:16px;}
  h1{font-size:clamp(20px,2.8vw,28px); margin:0 0 6px; display:flex; gap:.5em; align-items:center}
  h1 .badge{font-size:.7em; color:#fff; background:var(--accent); padding:.2em .6em; border-radius:999px}
  .sub{color:var(--ink-soft); font-size:14px}

  .grid{
    display:grid;
    grid-template-columns: 300px 1fr;
    gap:16px;
    align-items:start;
    padding:16px 0 24px;
  }
  @media (max-width:900px){
    .grid{grid-template-columns:1fr}
  }

  /* Left controls */
  .panel{
    background:var(--panel);
    border:1px solid #e5e7eb;
    border-radius:14px;
    padding:14px;
    box-shadow: 0 3px 12px rgba(0,0,0,.04);
  }
  .section-title{font-weight:700; margin:.25rem 0 .5rem}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:.35rem 0}
  .tabs{display:flex; gap:8px; flex-wrap:wrap}
  .tab{
    background:#f1f5f9; color:#0f172a;
    padding:8px 12px; border-radius:10px; border:1px solid #e2e8f0;
    cursor:pointer; user-select:none;
    font-weight:600; font-size:14px;
  }
  .tab[aria-selected="true"]{background:#eef2ff; border-color:#c7d2fe; color:#3730a3; box-shadow:0 0 0 3px var(--ring)}
  .select, select, .toggle{
    border:1px solid #e5e7eb; border-radius:10px; background:#fff;
    padding:8px 10px; font-size:14px;
  }
  .toggle{display:flex; align-items:center; gap:.5em; cursor:pointer}
  .toggle input{width:18px; height:18px}
  .btn{
    background:var(--ink); color:#fff; border:0; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer;
  }
  .btn.primary{background:var(--accent)}
  .btn.good{background:var(--accent-2)}
  .btn.ghost{background:#f1f5f9; color:#0f172a}
  .btn:disabled{opacity:.6; cursor:not-allowed}
  .help{
    border-radius:12px; padding:10px 12px; background:#f8fafc; border:1px dashed #e5e7eb; color:#334155; font-size:14px
  }

  /* Main area */
  .stage{
    background:var(--panel);
    border:1px solid #e5e7eb;
    border-radius:14px;
    padding:14px;
    box-shadow: 0 3px 12px rgba(0,0,0,.04);
    display:grid; grid-template-columns: 360px 1fr; gap:16px;
  }
  @media (max-width:1000px){ .stage{grid-template-columns:1fr} }

  /* Clock */
  .clock-wrap{display:flex; flex-direction:column; gap:10px; align-items:center}
  .clock{
    width:340px; height:340px; max-width:100%;
    display:block;
    touch-action:none; user-select:none;
  }
  .clock .face{fill:#fff}
  .clock .rim{stroke:#e5e7eb; stroke-width:2}
  .clock .tick{stroke:#94a3b8; stroke-linecap:round}
  .clock .tick.hour{stroke-width:3}
  .clock .num{fill:#334155; font-weight:700; font-size:18px; text-anchor:middle; dominant-baseline:middle}
  .hand{stroke:#111827; stroke-linecap:round; transform-origin:170px 170px}
  .hand.hour{stroke-width:6}
  .hand.min{stroke-width:4}
  .pin{fill:#111827}
  .hint-5 .tick.min{opacity:.33}
  .hint-nums .num{opacity:.95}
  .hint-none .num{opacity:.15}
  .hint-none .tick.min{opacity:.15}

  /* Quiz / feedback */
  .prompt{font-weight:800; font-size:22px; margin:.2rem 0 .8rem}
  .choices{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px}
  .choice{
    border:2px solid #e5e7eb; border-radius:12px; background:#fff; padding:10px; cursor:pointer;
    font-weight:700; text-align:center;
  }
  .choice:hover{border-color:#c7d2fe; box-shadow:0 0 0 3px var(--ring)}
  .choice.correct{border-color:#86efac; background:#f0fdf4}
  .choice.wrong{border-color:#fecaca; background:#fef2f2}

  .status{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:.4rem; color:#475569; font-size:14px
  }
  .stat-pill{
    background:#f1f5f9; padding:6px 10px; border-radius:999px; border:1px solid #e2e8f0; font-weight:700
  }
  .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}

  /* Confetti */
  .confetti{position:fixed; inset:0; pointer-events:none; overflow:hidden}
  .confetti i{
    position:absolute; width:8px; height:14px; background:currentColor; top:-20px; border-radius:2px; opacity:.9;
    animation: fall 900ms linear forwards;
  }
  @keyframes fall{
    to{ transform: translateY(110vh) rotate(540deg)}
  }

  /* Help modal */
  dialog{border:0; border-radius:14px; padding:0; width:min(720px,92vw)}
  dialog::backdrop{background:rgba(15,23,42,.35)}
  .modal{padding:16px}
  .modal h2{margin:.2rem 0 .6rem}
  .modal .close{position:absolute; right:12px; top:10px; background:#f1f5f9; border:1px solid #e2e8f0; border-radius:999px; padding:6px 10px}
  .small{font-size:12px; color:#64748b}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Oriのとけいマスター <span class="badge">2年生向け</span></h1>
    <div class="sub">やさしい → ふつう → むずかしい の3レベルで、よむ・あわせる・けいさん を練習できるよ。</div>
  </div>
</header>

<div class="wrap grid">
  <!-- LEFT: controls -->
  <aside class="panel" aria-label="設定">
    <div class="section-title">モード</div>
    <div class="tabs" role="tablist" aria-label="練習モード">
      <button class="tab" role="tab" data-mode="read" aria-selected="true">① よむクイズ</button>
      <button class="tab" role="tab" data-mode="set">② 針をあわせる</button>
      <button class="tab" role="tab" data-mode="elapsed">③ 経過時間</button>
    </div>

    <div class="section-title">レベル</div>
    <div class="row">
      <select id="levelSel" aria-label="レベル">
        <option value="1">レベル1：じ と 30分（半）</option>
        <option value="2">レベル2：5分ごと</option>
        <option value="3">レベル3：1分まで</option>
      </select>
    </div>

    <div class="section-title">オプション</div>
    <label class="toggle row"><input type="checkbox" id="ampm"> 午前/午後をつかう（よむ・経過時間）</label>
    <label class="toggle row"><input type="checkbox" id="showNums" checked> 数字をひょうじ</label>
    <label class="toggle row"><input type="checkbox" id="hint5" checked> 5分ごとのメモリをつよく表示</label>

    <div class="section-title">あそびかた</div>
    <div class="help">
      ・① よむクイズ：とけいを見て、正しい「◯時◯分」をえらぼう。<br>
      ・② 針をあわせる：お題の時間にぴったりなるように、分針をドラッグ（ひっぱる）してね。<br>
      ・③ 経過時間：たとえば「2時20分から30分後は？」のような問題だよ。<br>
      <button class="btn ghost" id="openHelp" style="margin-top:8px">くわしい説明をひらく</button>
    </div>
  </aside>

  <!-- RIGHT: stage -->
  <main class="stage" aria-live="polite">
    <div class="clock-wrap">
      <svg class="clock hint-5" viewBox="0 0 340 340" aria-label="アナログとけい" id="clockSvg">
        <defs>
          <filter id="shadow"><feDropShadow dx="0" dy="1" stdDeviation="1" flood-color="#000" flood-opacity=".1"/></filter>
        </defs>
        <g transform="translate(10,10)">
          <circle cx="160" cy="160" r="158" class="face" />
          <circle cx="160" cy="160" r="158" class="rim" />
          <!-- minute ticks -->
          <g id="ticks"></g>
          <!-- numbers -->
          <g id="nums"></g>
          <!-- hands -->
          <line id="hourHand" class="hand hour" x1="160" y1="160" x2="160" y2="95" />
          <line id="minHand" class="hand min" x1="160" y1="160" x2="160" y2="60" />
          <circle cx="160" cy="160" r="4" class="pin" />
        </g>
      </svg>
      <div class="status">
        <span class="stat-pill">⭐ <span id="score">0</span></span>
        <span class="stat-pill">れんさ：<span id="streak">0</span></span>
        <span class="stat-pill">正解率：<span id="rate">0%</span></span>
      </div>
      <div class="actions">
        <button class="btn primary" id="nextBtn">スタート / つぎへ</button>
        <button class="btn" id="replayBtn" disabled>もう1回</button>
        <button class="btn ghost" id="showAnsBtn" disabled>こたえを見る</button>
      </div>
    </div>

    <section>
      <div class="prompt" id="prompt">よういはいい？「スタート」をおしてね。</div>
      <div class="choices" id="choices" role="group" aria-label="こたえ"></div>
      <div class="small" id="tinyMsg"></div>
    </section>
  </main>
</div>

<!-- Help modal -->
<dialog id="helpDlg">
  <div class="modal">
    <button class="close" id="closeHelp">とじる</button>
    <h2>くわしい説明（Oriへ）</h2>
    <p>
      ・まずは レベル1 からはじめよう。長い針（分しん）が「12」なら「ちょうど」。<br>
      ・「6」にくると「半（はん）」だよ。たとえば「3時半」。<br>
      ・レベル2では 5分ごとに読むれんしゅう。長い針が「1」なら「5分」、「2」なら「10分」…だよ。<br>
      ・レベル3は1分きざみ。ながい針が少しでも動くと分がふえるよ。<br>
      ・②のモードでは、とけいをドラッグして分しんを動かせるよ。レベルによって 30分/5分/1分 ごとにピタッと止まるよ。<br>
      ・午前/午後（AM/PM）をつかう にチェックを入れると、「午前3時」「午後3時」みたいな出題にもチャレンジできるよ。
    </p>
  </div>
</dialog>

<div class="confetti" id="confetti" aria-hidden="true"></div>

<script>
/* ===== Utilities ===== */
const $ = (s, el=document) => el.querySelector(s);
const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
const pad2 = n => n.toString().padStart(2,'0');

function randInt(min,max){ // inclusive
  return Math.floor(Math.random()*(max-min+1))+min;
}
function choice(arr){return arr[Math.floor(Math.random()*arr.length)];}
function clamp(v,min,max){return Math.max(min, Math.min(max, v));}

function to12h(h){ const hour = h%12===0?12:h%12; const am = h<12; return {hour, am}; }
function jTime(h24, m, useAMPM=false, useColloquial=true){
  // Return Japanese string like "3時5分", "3時半", "午前3時" etc.
  let ampm = '';
  let h = h24;
  if(useAMPM){
    const t = to12h(h24);
    ampm = t.am ? '午前' : '午後';
    h = t.hour;
  }
  let body = '';
  if(useColloquial && m===0) body = `${h}時ちょうど`;
  else if(useColloquial && m===30) body = `${h}時半`;
  else body = `${h}時${m}分`;
  return (ampm? ampm : '') + body;
}
function minuteSnapByLevel(level){
  if(level==1) return 30;
  if(level==2) return 5;
  return 1;
}

/* ===== State ===== */
const state = {
  mode:'read', // 'read' | 'set' | 'elapsed'
  level:1,
  useAmPm:false,
  showNums:true,
  hint5:true,

  // current challenge
  target:{h:3, m:30}, // 24h, 0-23
  targetDelta:0, // minutes for elapsed mode

  // score
  score:0, streak:0, total:0, correct:0,

  // clock
  clock:{h:3, m:30}, // what the hands show (for "set" mode)
  dragging:false,
};

/* ===== Build static SVG ticks & numbers ===== */
(function buildClockFace(){
  const ticks = $('#ticks');
  const nums  = $('#nums');
  for(let i=0;i<60;i++){
    const angle = i*6*Math.PI/180;
    const cx=160, cy=160;
    const rOuter = 150;
    const isHour = i%5===0;
    const len = isHour? 16 : 8;
    const r1 = rOuter - len;
    const x1 = cx + r1 * Math.sin(angle);
    const y1 = cy - r1 * Math.cos(angle);
    const x2 = cx + rOuter * Math.sin(angle);
    const y2 = cy - rOuter * Math.cos(angle);
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',x1); line.setAttribute('y1',y1);
    line.setAttribute('x2',x2); line.setAttribute('y2',y2);
    line.setAttribute('class','tick '+(isHour?'hour':'min'));
    ticks.appendChild(line);
  }
  for(let n=1;n<=12;n++){
    const angle = (n%12)*30*Math.PI/180;
    const cx=160, cy=160, r=120;
    const x = cx + r * Math.sin(angle);
    const y = cy - r * Math.cos(angle);
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x',x); t.setAttribute('y',y); t.setAttribute('class','num');
    t.textContent = n;
    nums.appendChild(t);
  }
})();

/* ===== Clock rendering ===== */
function setHands(h24, m){
  const hourDeg = ((h24%12)*30) + (m*0.5);
  const minDeg  = m*6;
  $('#hourHand').style.transform = `rotate(${hourDeg}deg)`;
  $('#minHand').style.transform  = `rotate(${minDeg}deg)`;
}
function applyHints(){
  const svg = $('#clockSvg');
  svg.classList.toggle('hint-none', !state.showNums && !state.hint5);
  svg.classList.toggle('hint-nums', state.showNums);
  svg.classList.toggle('hint-5', state.hint5);
}

/* ===== Random time generators by level ===== */
function genTime(level, allowAllHours=true){
  const h = allowAllHours ? randInt(0,23) : randInt(1,12); // keep 24h internally
  let m=0;
  if(level===1){ m = choice([0,30]); }
  else if(level===2){ m = randInt(0,11)*5; }
  else { m = randInt(0,59); }
  return {h, m};
}
function genDelta(level){
  if(level===1) return choice([30,60,90,120]); // simple jumps
  if(level===2) return choice([5,10,15,20,25,30,35,40,45,50,55,60]);
  return randInt(3,120); // any minutes up to 2h
}
function addMinutes(h24,m,delta){
  let total = h24*60 + m + delta;
  // keep in 0..1439
  total = ((total%1440)+1440)%1440;
  return {h: Math.floor(total/60), m: total%60};
}

/* ===== Challenges ===== */
function newChallenge(){
  $('#choices').innerHTML='';
  $('#tinyMsg').textContent='';
  $('#showAnsBtn').disabled = true;
  $('#replayBtn').disabled = true;

  if(state.mode==='read'){
    state.target = genTime(state.level, true);
    setHands(state.target.h, state.target.m);
    $('#prompt').textContent = 'この とけいは なんじ なんぷん？（正しいよみかたを えらんでね）';
    buildChoicesForRead();
  }else if(state.mode==='set'){
    state.target = genTime(state.level, true);
    // show target text, reset shown clock to a different random spot
    const t = jTime(state.target.h, state.target.m, state.useAmPm, true);
    $('#prompt').textContent = `お題： ${t} にぴったり あわせてみよう。分針（長い針）をドラッグしてね。`;
    state.clock = genTime(3,true);
    setHands(state.clock.h, state.clock.m);
    $('#showAnsBtn').disabled = false;
    $('#replayBtn').disabled = false;
  }else if(state.mode==='elapsed'){
    state.target = genTime(state.level, true);
    state.targetDelta = genDelta(state.level);
    const q = state.useAmPm ? jTime(state.target.h,state.target.m,true,true)
                            : jTime(state.target.h,state.target.m,false,true);
    $('#prompt').textContent = `${q} から ${state.targetDelta}分 あと（ご）は なんじなんぷん？`;
    setHands(state.target.h, state.target.m);
    buildChoicesForElapsed();
  }
}

function buildChoicesForRead(){
  const correct = jTime(state.target.h, state.target.m, state.useAmPm, true);
  const set = new Set([correct]);

  // distractors
  while(set.size<4){
    const d = genTime(state.level,true);
    set.add( jTime(d.h,d.m, state.useAmPm, true) );
  }
  const list = Array.from(set).sort(()=>Math.random()-0.5);
  const box = $('#choices');
  for(const label of list){
    const b = document.createElement('button');
    b.className='choice';
    b.textContent = label;
    b.onclick = () => {
      const ok = label===correct;
      onAnswer(ok);
      b.classList.add(ok?'correct':'wrong');
      // mark the correct one
      for(const c of $$('.choice')) if(c.textContent===correct) c.classList.add('correct');
      disableChoices();
    };
    box.appendChild(b);
  }
}

function buildChoicesForElapsed(){
  const ans = addMinutes(state.target.h, state.target.m, state.targetDelta);
  const correct = jTime(ans.h, ans.m, state.useAmPm, true);
  const set = new Set([correct]);

  while(set.size<4){
    // +/- small offsets
    const offset = choice([-20,-15,-10,-5,5,10,15,20,25,30]);
    const d = addMinutes(state.target.h, state.target.m, state.targetDelta + offset);
    set.add( jTime(d.h, d.m, state.useAmPm, true) );
  }
  const list = Array.from(set).sort(()=>Math.random()-0.5);
  const box = $('#choices'); box.innerHTML='';
  for(const label of list){
    const b = document.createElement('button');
    b.className='choice';
    b.textContent = label;
    b.onclick = () => {
      const ok = label===correct;
      onAnswer(ok);
      b.classList.add(ok?'correct':'wrong');
      for(const c of $$('.choice')) if(c.textContent===correct) c.classList.add('correct');
      disableChoices();
    };
    box.appendChild(b);
  }
}

function disableChoices(){
  for(const c of $$('.choice')) c.disabled=true;
  $('#replayBtn').disabled = false;
}

/* ===== Scoring & feedback ===== */
function onAnswer(ok){
  state.total++;
  if(ok){ state.score+=10; state.correct++; state.streak++; cheer(); }
  else { state.streak=0; boo(); }
  updateStats();
}
function updateStats(){
  $('#score').textContent = state.score;
  $('#streak').textContent = state.streak;
  const rate = state.total? Math.round(100*state.correct/state.total) : 0;
  $('#rate').textContent = `${rate}%`;
}

/* ===== Confetti ===== */
function cheer(){
  const c = $('#confetti');
  for(let i=0;i<20;i++){
    const p = document.createElement('i');
    p.style.left = Math.random()*100+'vw';
    p.style.color = ['#22c55e','#10b981','#34d399','#a7f3d0','#86efac','#6366f1','#f59e0b'][randInt(0,6)];
    p.style.animationDelay = (Math.random()*0.2)+'s';
    c.appendChild(p);
    setTimeout(()=>p.remove(), 1200);
  }
  tip('やったね！つぎも いってみよう！');
}
function boo(){
  tip('おしい！ 針の位置を よく見てみよう。');
}
function tip(msg){
  $('#tinyMsg').textContent = msg;
}

/* ===== Drag to set clock (minutes) ===== */
(function initDrag(){
  const svg = $('#clockSvg');
  const minHand = $('#minHand');
  function getAngle(ev){
    const r = svg.getBoundingClientRect();
    const cx = r.left + r.width/2;
    const cy = r.top + r.height/2;
    const x = (ev.touches? ev.touches[0].clientX : ev.clientX) - cx;
    const y = (ev.touches? ev.touches[0].clientY : ev.clientY) - cy;
    // 12時=0°, 時計回りで増える角度
    const deg = (Math.atan2(y,x)*180/Math.PI + 90 + 360) % 360;
    return deg;
  }
  function handleMove(ev){
    if(!state.dragging || state.mode!=='set') return;
    ev.preventDefault();
    let deg = getAngle(ev);
    const snap = minuteSnapByLevel(state.level);
    let minute = Math.round(deg/6);
    // snap minute
    minute = Math.round(minute / snap) * snap;
    minute = (minute+60)%60;

    // adjust hour if minute wraps relative to current minute to keep intuitive behavior
    const prev = state.clock.m;
    state.clock.m = minute;
    let h = state.clock.h;
    // if moving across 12, adjust hour roughly
    if(prev>=45 && minute<=15) h = (h+1)%24;
    if(prev<=15 && minute>=45) h = (h+23)%24;
    // hour hand follows minute continuously
    state.clock.h = h;
    setHands(state.clock.h, state.clock.m);

    // if near target, auto check happy path
    maybeAutoCheck();
  }
  function down(ev){ if(state.mode==='set'){ state.dragging=true; handleMove(ev);} }
  function up(){ state.dragging=false; }
  ['pointerdown','mousedown','touchstart'].forEach(e=>svg.addEventListener(e,down,{passive:false}));
  ['pointermove','mousemove','touchmove'].forEach(e=>window.addEventListener(e,handleMove,{passive:false}));
  ['pointerup','mouseup','mouseleave','touchend','touchcancel'].forEach(e=>window.addEventListener(e,up));
})();

function maybeAutoCheck(){
  if(state.mode!=='set') return;
  const a = state.clock;
  const b = state.target;
  // accept within 1 minute at level3, 2 minutes at level2, 3 minutes at level1
  const tol = state.level===3?1 : state.level===2?2 : 3;
  const diff = Math.abs((a.h*60+a.m) - (b.h*60+b.m));
  const wrapped = Math.min(diff, 1440-diff);
  if(wrapped<=tol){
    tip('ぴったり！すごい！');
    onAnswer(true);
    $('#showAnsBtn').disabled = true;
    $('#replayBtn').disabled = false;
  }
}

/* ===== UI wiring ===== */
for(const t of $$('.tab')){
  t.addEventListener('click', ()=>{
    $$('.tab').forEach(el=>el.setAttribute('aria-selected','false'));
    t.setAttribute('aria-selected','true');
    state.mode = t.dataset.mode;
    $('#choices').innerHTML='';
    $('#prompt').textContent = 'スタート をおしてね。';
    $('#tinyMsg').textContent='';
    $('#showAnsBtn').disabled = state.mode!=='set';
    $('#replayBtn').disabled = true;
  });
}
$('#levelSel').addEventListener('change', e=>{
  state.level = +e.target.value;
});
$('#ampm').addEventListener('change', e=>{ state.useAmPm = e.target.checked; });
$('#showNums').addEventListener('change', e=>{ state.showNums = e.target.checked; applyHints(); });
$('#hint5').addEventListener('change', e=>{ state.hint5 = e.target.checked; applyHints(); });
$('#nextBtn').addEventListener('click', newChallenge);
$('#replayBtn').addEventListener('click', ()=>{
  if(state.mode==='read' || state.mode==='elapsed') newChallenge();
  else{
    // reset clock to a random pose for set-mode
    state.clock = genTime(3,true);
    setHands(state.clock.h, state.clock.m);
    $('#tinyMsg').textContent='もういっかい やってみよう！';
  }
});
$('#showAnsBtn').addEventListener('click', ()=>{
  if(state.mode!=='set') return;
  const t = jTime(state.target.h, state.target.m, state.useAmPm, true);
  tip('こたえは → ' + t);
  // also snap the clock to answer for学び
  setHands(state.target.h, state.target.m);
});
$('#openHelp').addEventListener('click', ()=>$('#helpDlg').showModal());
$('#closeHelp').addEventListener('click', ()=>$('#helpDlg').close());

/* Initial render */
applyHints();
setHands(state.clock.h, state.clock.m);
updateStats();
</script>
</body>
</html>
